<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All India Rank College Predictor</title>

  <!-- Inter + Poppins look (clean, student-focused) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand: #e6403a;
      --brand-600:#d8352e;
      --brand-soft:#fff1f0;
      --ink:#111827;
      --muted:#6b7280;
      --bg:#f7f8fb;
      --card:#ffffff;
      --stroke:#e5e7eb;
      --ring:#cfe2ff;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      background:#fff;
      border-bottom:1px solid var(--stroke);
      backdrop-filter: blur(8px);
    }
    .topbar-inner{
      max-width:1200px; margin:0 auto; padding:14px 20px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .brand-badge{
      display:flex; align-items:center; gap:12px;
      font-weight:700; color:#1f2937;
    }
    .badge{
      width:34px; height:34px; border-radius:10px;
      background:var(--brand); color:#fff; display:grid; place-items:center;
      font-family:Poppins, Inter, sans-serif; font-weight:600;
      letter-spacing:0.2px;
      box-shadow:0 6px 20px rgba(230,64,58,.25);
    }
    .site-link{
      margin-left:auto;
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 14px; border-radius:999px;
      background:var(--brand-soft); color:var(--brand); text-decoration:none; font-weight:600;
      border:1px solid #ffd6d3;
    }
    .site-link:hover{ background:#ffe6e4; }

    .wrap{ max-width:1200px; margin:30px auto; padding:0 20px; }
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:14px;
      box-shadow:0 20px 60px rgba(16,24,40,.06);
      padding:26px;
    }

    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width: 900px){ .grid-2{ grid-template-columns:1fr; } }

    h1{
      margin:0 0 18px 0;
      font-family:Poppins, Inter, sans-serif;
      font-size:26px; font-weight:700; letter-spacing:.2px;
    }

    label{ font-weight:600; color:#374151; display:block; margin:10px 0 8px; }
    input[type="text"],input[type="email"],input[type="tel"],input[type="number"],select{
      width:100%;
      padding:13px 14px;
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:10px; font-size:15px; color:#1f2937;
      outline:none;
      transition:border .2s, box-shadow .2s, background .2s;
    }
    input::placeholder{ color:#9ca3af; }
    input:focus,select:focus{
      border-color:#bcd3ff; box-shadow:0 0 0 4px var(--ring);
      background:#fff;
    }
    .help{ font-size:12.5px; color:var(--muted); margin-top:6px; }
    .error{ color:#dc2626; font-size:13px; margin-top:6px; }

    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:12px 16px; border-radius:10px; font-weight:700;
      transition:.2s transform, .2s box-shadow, .2s background;
    }
    .btn-primary{
      background:var(--brand); color:#fff; box-shadow:0 10px 18px rgba(230,64,58,.25);
    }
    .btn-primary:hover{ background:var(--brand-600); transform:translateY(-1px); }
    .btn-ghost{ background:transparent; color:#0d6efd; }

    .btn[disabled]{ opacity:.7; cursor:not-allowed; }

    .header-row{
      display:flex; align-items:center; gap:14px; justify-content:space-between; flex-wrap:wrap;
    }
    .greeting{
      border:1px dashed #fecaca;
      background:var(--brand-soft);
      color:#b91c1c; padding:12px 14px;
      border-radius:10px; margin:10px 0 16px;
      font-weight:600;
    }
    .radio-row{ display:flex; align-items:center; gap:18px; margin-top:4px; flex-wrap:wrap; }
    .radio-row label{ margin:0; font-weight:500; color:#1f2937; }

    @media (max-width: 900px){
      .header-row{ flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-badge">
        <div class="badge">CS</div>
        <div>All India Rank College Predictor</div>
      </div>
      <a class="site-link" href="#" onclick="return false;">Concept Simplified</a>
    </div>
  </header>

  <main class="wrap">
    <!-- STUDENT DETAILS -->
    <section id="detailsSection" class="card" style="display:none;">
      <h1>Enter Student Details</h1>
      <form id="detailsForm" novalidate>
        <div class="grid-2">
          <div>
            <label for="studentName">Full Name</label>
            <input id="studentName" type="text" placeholder="e.g., Agam Puri" />
            <div id="errName" class="error"></div>
          </div>
          <div>
            <label for="studentEmail">Email</label>
            <input id="studentEmail" type="email" placeholder="e.g., name@example.com" />
            <div id="errEmail" class="error"></div>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label for="studentMobile">Mobile Number</label>
            <input id="studentMobile" type="tel" inputmode="numeric" maxlength="10" placeholder="10-digit Indian mobile" />
            <div class="help">Weâ€™ll use this to share prediction updates.</div>
            <div id="errMobile" class="error"></div>
          </div>
          <div>
            <label for="studentState">State / Union Territory</label>
            <select id="studentState">
              <option value="">Select State</option>
            </select>
            <div id="errState" class="error"></div>
          </div>
        </div>

        <div>
          <label for="studentCity">City</label>
          <input id="studentCity" type="text" placeholder="e.g., Pune" />
          <div id="errCity" class="error"></div>
        </div>

        <div style="margin-top:14px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <button id="saveContinueBtn" class="btn btn-primary" type="submit">Save & Continue</button>
          <span class="help">By continuing, you consent to store your details for counseling and updates.</span>
        </div>
      </form>
    </section>

    <!-- PREDICTOR -->
    <section id="predictorSection" class="card" style="display:none;">
      <div class="header-row">
        <h1>Find Your Best-Fit Colleges</h1>
        <button id="editDetailsBtn" class="btn btn-ghost" type="button">Edit details</button>
      </div>

      <div id="helloBanner" class="greeting" style="display:none;"></div>

      <!-- Exam -->
      <div>
        <label for="exam">Select Exam</label>
        <select id="exam">
          <option value="" disabled selected>Select Exam</option>
          <option value="JEE">JEE Mains-2025</option>
          <option value="NEET-2025">NEET-2025</option>
          <option value="MHT-CET">MHT-CET</option>
        </select>
      </div>

      <!-- Method -->
      <div style="margin-top:8px">
        <label>Prediction Method</label>
        <div class="radio-row">
          <label><input type="radio" name="method" value="Percentile" checked> Exam Percentile</label>
          <label><input type="radio" name="method" value="Rank"> All India Merit Rank</label>
        </div>
      </div>

      <!-- Score -->
      <div style="margin-top:10px">
        <label for="score" id="scoreLabel">Enter Percentile</label>
        <input type="text" id="score" placeholder="Enter percentile or rank">
      </div>

      <!-- Branch -->
      <div style="margin-top:10px">
        <label for="branch">Select Branch</label>
        <select id="branch">
          <option value="All Branches">All Branches</option>
        </select>
      </div>

      <div style="margin-top:16px">
        <button class="btn btn-primary" type="button" onclick="predictCollege()">Show results</button>
      </div>
    </section>
  </main>

  <script>
    /* CONFIG: Google Apps Script URL */
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxuvG2sjXREA4bI6Aovld8eEXYWwuN6C46fK50MI6O3H_Jw0meMOAwBTTHxf8eLnKToBg/exec";

    /* 1. STATE LIST */
    const statesIN = [
      "Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chhattisgarh","Goa","Gujarat",
      "Haryana","Himachal Pradesh","Jharkhand","Karnataka","Kerala","Madhya Pradesh","Maharashtra",
      "Manipur","Meghalaya","Mizoram","Nagaland","Odisha","Punjab","Rajasthan","Sikkim","Tamil Nadu",
      "Telangana","Tripura","Uttar Pradesh","Uttarakhand","West Bengal",
      "Andaman and Nicobar Islands","Chandigarh","Dadra and Nagar Haveli and Daman and Diu","Delhi",
      "Jammu and Kashmir","Ladakh","Lakshadweep","Puducherry"
    ];
    function fillStates(){
      const sel = document.getElementById('studentState');
      statesIN.forEach(s=>{
        const o = document.createElement('option');
        o.value=s; o.textContent=s;
        sel.appendChild(o);
      });
    }

    /* 2. LOCAL STORAGE HELPERS */
    const LS_KEY = "studentDetails";
    const getDetails = () => {
      try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; }
    };
    const saveDetails = (d) => localStorage.setItem(LS_KEY, JSON.stringify(d));

    /* 3. VALIDATE DETAILS FORM */
    function validateDetails(){
      const name   = document.getElementById('studentName').value.trim();
      const email  = document.getElementById('studentEmail').value.trim();
      const mobile = document.getElementById('studentMobile').value.trim();
      const state  = document.getElementById('studentState').value.trim();
      const city   = document.getElementById('studentCity').value.trim();

      ['errName','errEmail','errMobile','errState','errCity'].forEach(id=>document.getElementById(id).textContent='');

      let ok=true;
      if(!name){ document.getElementById('errName').textContent='Please enter your name.'; ok=false; }
      const emailOK=/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email);
      if(!emailOK){ document.getElementById('errEmail').textContent='Please enter a valid email.'; ok=false; }
      const mobileOK=/^[6-9]\d{9}$/.test(mobile);
      if(!mobileOK){ document.getElementById('errMobile').textContent='Enter a valid 10-digit Indian mobile number.'; ok=false; }
      if(!state){ document.getElementById('errState').textContent='Select your state.'; ok=false; }
      if(!city){ document.getElementById('errCity').textContent='Enter your city.'; ok=false; }

      return ok ? {name,email,mobile,state,city} : null;
    }

    /* 4. POST TO SHEETS WHEN SAVING DETAILS */
    async function postToSheet(payload){
      if(!WEBAPP_URL || WEBAPP_URL.startsWith("PASTE_")) return;
      const body = JSON.stringify({ ...payload, source:"all-india-index", ua:navigator.userAgent });
      await fetch(WEBAPP_URL, { method:'POST', mode:'no-cors', body });
      await new Promise(r=>setTimeout(r,400));
      return true;
    }

    /* 4b. LOG PREDICTION (exam / method / score / branch) */
    function logPrediction(exam, method, scoreInput, branch){
      if(!WEBAPP_URL || WEBAPP_URL.startsWith("PASTE_")) return;
      const details = getDetails();
      if(!details) return;
      const payload = {
        ...details,
        source: "all-india-prediction",
        ua: navigator.userAgent,
        exam,
        method,
        inputValue: scoreInput,
        branch
      };
      // fire-and-forget (no await)
      fetch(WEBAPP_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(payload) })
        .catch(err => console.error("logPrediction failed:", err));
    }

    /* 5. ALL-INDIA PREDICTOR LOGIC */
    let data = null;

    async function loadData() {
      try {
        const response = await fetch('MHT-CET All India JEE Mains Cutoff.json');
        data = await response.json();
        populateBranches();
      } catch (error) {
        console.error("Error loading JSON file", error);
        alert("Failed to load college data. Please try again later.");
      }
    }

    function populateBranches() {
      if (!data) return;
      const dataset = data["Cleaned_MHT-CET_Cutoff_Data (1)"] || [];
      const branchSelect = document.getElementById("branch");
      const branches = new Set();
      
      dataset.forEach(college => {
        if(college["Branch Name"]) branches.add(college["Branch Name"].trim());
      });
      
      branches.forEach(branch => {
        const option = document.createElement("option");
        option.value = branch;
        option.textContent = branch;
        branchSelect.appendChild(option);
      });
    }

    function predictCollege() {
      if (!data) {
        alert("Data not loaded yet. Please wait a moment and try again.");
        return;
      }

      const examEl = document.getElementById("exam");
      const exam = examEl.value;
      const method = document.querySelector('input[name="method"]:checked').value;
      const scoreInput = document.getElementById("score").value.trim();
      const branch = document.getElementById("branch").value;

      if (!exam) {
        alert("Please select an exam.");
        return;
      }
      if (!scoreInput) {
        alert("Please enter a valid score.");
        return;
      }

      const score = parseFloat(scoreInput);
      if (isNaN(score)) {
        alert("Invalid input. Please enter a valid number.");
        return;
      }

      let filteredData = data["Cleaned_MHT-CET_Cutoff_Data (1)"].filter(college => college["Merit Exam"] === exam);

      if (method === "Percentile") {
        filteredData = filteredData.filter(college => parseFloat(college["JEE Mains Percentile"]) <= score);
      } else {
        filteredData = filteredData.filter(college => parseInt(college["All India State Rank"]) >= score);
      }

      if (branch !== "All Branches") {
        filteredData = filteredData.filter(college => college["Branch Name"] && college["Branch Name"].trim() === branch);
      }

      filteredData = filteredData.slice(0, 25);

      if (filteredData.length === 0) {
        alert("No matching colleges found.");
        return;
      }

      // ðŸ”´ NEW: log prediction with exam + method + score + branch
      logPrediction(exam, method, scoreInput, branch);

      // Store filtered data
      localStorage.setItem("results", JSON.stringify(filteredData));

      // Redirect to results page
      window.location.href = "results.html";
    }

    /* 6. UI TOGGLES */
    function showPredictor(details){
      const banner = document.getElementById('helloBanner');
      banner.textContent = `Hi ${details.name}, let's get personalised college suggestions for you.`;
      banner.style.display = 'block';
      document.getElementById('detailsSection').style.display='none';
      document.getElementById('predictorSection').style.display='block';
    }

    function showDetailsForm(prefill){
      document.getElementById('predictorSection').style.display='none';
      document.getElementById('detailsSection').style.display='block';
      if(prefill){
        document.getElementById('studentName').value   = prefill.name   || "";
        document.getElementById('studentEmail').value  = prefill.email  || "";
        document.getElementById('studentMobile').value = prefill.mobile || "";
        document.getElementById('studentState').value  = prefill.state  || "";
        document.getElementById('studentCity').value   = prefill.city   || "";
      }
    }

    /* 7. BOOTSTRAP */
    document.addEventListener('DOMContentLoaded', ()=>{
      fillStates();
      loadData();

      document.querySelectorAll('input[name="method"]').forEach(r=>{
        r.addEventListener('change', ()=>{
          const val = document.querySelector('input[name="method"]:checked').value;
          const lab = document.getElementById('scoreLabel');
          const inp = document.getElementById('score');
          if(val === 'Rank'){
            lab.textContent = 'Enter Rank';
            inp.placeholder = 'e.g., 32450';
          } else {
            lab.textContent = 'Enter Percentile';
            inp.placeholder = 'e.g., 96.4';
          }
        });
      });

      const existing = getDetails();
      if(existing && existing.name && existing.email && existing.mobile && existing.state && existing.city){
        showPredictor(existing);
      }else{
        showDetailsForm(existing);
      }

      const form = document.getElementById('detailsForm');
      const btn  = document.getElementById('saveContinueBtn');
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const data = validateDetails();
        if(!data) return;

        const original = btn.textContent;
        btn.disabled = true; btn.textContent = "Savingâ€¦";
        try{
          await postToSheet(data);
          saveDetails(data);
          showPredictor(data);
        }catch(err){
          console.error(err);
          alert("Could not save your details. Please try again.");
        }finally{
          btn.disabled = false; btn.textContent = original;
        }
      });

      document.getElementById('editDetailsBtn').addEventListener('click', ()=>{
        showDetailsForm(getDetails() || {});
      });
    });
  </script>
</body>
</html>
